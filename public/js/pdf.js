/* ===============================
   IMAGE HELPERS
================================ */
function getBase64Image(url) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.setAttribute("crossOrigin", "anonymous");
    img.onload = () => {
      const canvas = document.createElement("canvas");
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0);
      const dataURL = canvas.toDataURL("image/png");
      resolve(dataURL);
    };
    img.onerror = (err) => reject(err);
    img.src = url;
  });
}

async function generatePDF(b) {
  const { jsPDF } = window.jspdf || {};
  
  if (!b) {
    alert("No booking data found to generate PDF");
    return;
  }
  if (!jsPDF) {
    alert("PDF library not loaded. Please wait a moment or refresh.");
    return;
  }

  const doc = new jsPDF();

  // Add Logo
  try {
    const logoData = await getBase64Image("assets/logo.png");
    doc.addImage(logoData, "PNG", 15, 10, 30, 15);
  } catch (e) {
    console.warn("Logo failed to load");
  }

  doc.setFontSize(22);
  doc.setTextColor(40, 44, 52);
  doc.text("SFO Meeting Suite", 105, 25, { align: "center" });
  
  doc.setFontSize(14);
  doc.setTextColor(100);
  doc.text("OFFICIAL BOOKING CONFIRMATION", 105, 35, { align: "center" });

  doc.setDrawColor(200);
  doc.line(15, 45, 195, 45);

  doc.setFontSize(12);
  doc.setTextColor(0);

  let y = 60;
  const row = (k, v) => {
    doc.setFont("helvetica", "bold");
    doc.text(`${k}:`, 30, y);
    doc.setFont("helvetica", "normal");
    doc.text(String(v || "-"), 90, y);
    y += 12;
  };

  row("Tracking ID", b.trackId);
  row("Status", (b.status || "PENDING").toUpperCase());
  row("Room", b.room);
  row("Division", b.division);
  row("Date", b.date);
  row("Time", `${b.start} â€“ ${b.end}`);
  row("Team", b.team || "-");
  row("Attendees", b.attendees);
  row("Meeting Type", b.meetingType);
  row("Booked By", b.user || b.email);

  // Add Status Text (Large)
  y += 10;
  doc.setFontSize(24);
  const status = (b.status || "PENDING").toUpperCase();
  if (status === "APPROVED") {
    doc.setTextColor(34, 197, 94); // Green
    doc.text("APPROVED", 105, y, { align: "center" });
  } else if (status === "REJECTED") {
    doc.setTextColor(239, 68, 68); // Red
    doc.text("REJECTED", 105, y, { align: "center" });
  } else {
    doc.setTextColor(234, 179, 8); // Yellow
    doc.text("PENDING APPROVAL", 105, y, { align: "center" });
  }

  // Add Seal at bottom right
  try {
    const sealData = await getBase64Image("assets/seal.png");
    doc.addImage(sealData, "PNG", 150, 230, 40, 40);
  } catch (e) {
    console.warn("Seal failed to load");
  }

  doc.setFontSize(10);
  doc.setTextColor(150);
  doc.text("Generated by SFO Meeting Suite Enterprise Portal", 105, 285, { align: "center" });
  doc.text(new Date().toLocaleString(), 105, 290, { align: "center" });

  doc.save(`SFO_Booking_${b.trackId}.pdf`);
}

function emailConfirmation(b) {
  if (!b) return alert("No booking data");
  
  const to = encodeURIComponent(b.email || "");
  const subject = encodeURIComponent(`Meeting Room Booking Confirmation â€” ${b.room}`);
  const body = encodeURIComponent(`
Hello ${b.user || "Team"},

Your meeting room booking details are below.

ðŸ“Œ Booking Details:
â€¢ Track ID: ${b.trackId}
â€¢ Room: ${b.room}
â€¢ Division: ${b.division}
â€¢ Date: ${b.date}
â€¢ Time: ${b.start} - ${b.end}
â€¢ Status: ${b.status}

Regards,
SFO Meeting Suite
  `.trim());

  window.location.href = `mailto:${to}?subject=${subject}&body=${body}`;
}
