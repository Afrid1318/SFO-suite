/* =====================================================
   CONFIRMATION PAGE LOGIC â€” FINAL
===================================================== */

const { jsPDF } = window.jspdf || {};

const booking = (() => {
  try {
    return JSON.parse(localStorage.getItem("latest_booking"));
  } catch {
    return null;
  }
})();

if (!booking) {
  alert("Booking not found. Redirecting.");
  location.href = "dashboard.html";
}

/* ===============================
   RENDER DETAILS
================================ */
const details = document.getElementById("confirmDetails");

const status = (booking.status || "PENDING").toLowerCase();
details.innerHTML = `
  <div class="detail-row"><b>Tracking ID</b><span>${booking.trackId}</span></div>
  <div class="detail-row"><b>Room</b><span>${booking.room}</span></div>
  <div class="detail-row"><b>Division</b><span>${booking.division}</span></div>
  <div class="detail-row"><b>Date</b><span>${booking.date}</span></div>
  <div class="detail-row"><b>Time</b>
    <span>${booking.start} â€“ ${booking.end}</span>
  </div>
  <div class="detail-row"><b>Team</b><span>${booking.team || "-"}</span></div>
  <div class="detail-row"><b>Attendees</b><span>${booking.attendees}</span></div>
  <div class="detail-row">
    <b>Status</b>
    <span class="status ${status}">${booking.status || "PENDING"}</span>
  </div>
`;

/* ===============================
   IMAGE HELPERS
================================ */
function getBase64Image(url) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.setAttribute("crossOrigin", "anonymous");
    img.onload = () => {
      const canvas = document.createElement("canvas");
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0);
      const dataURL = canvas.toDataURL("image/png");
      resolve(dataURL);
    };
    img.onerror = (err) => reject(err);
    img.src = url;
  });
}

/* ===============================
   PDF GENERATION
================================ */
async function generatePDFBlob() {
  if (!jsPDF) return null;

  const doc = new jsPDF();

  // Add Logo
  try {
    const logoData = await getBase64Image("assets/logo.png");
    doc.addImage(logoData, "PNG", 15, 10, 30, 15);
  } catch (e) {
    console.warn("Logo failed to load");
  }

  doc.setFontSize(22);
  doc.setTextColor(40, 44, 52);
  doc.text("SFO Meeting Suite", 105, 25, { align: "center" });
  
  doc.setFontSize(14);
  doc.setTextColor(100);
  doc.text("OFFICIAL BOOKING CONFIRMATION", 105, 35, { align: "center" });

  doc.setDrawColor(200);
  doc.line(15, 45, 195, 45);

  doc.setFontSize(12);
  doc.setTextColor(0);

  let y = 60;
  const row = (k, v) => {
    doc.setFont("helvetica", "bold");
    doc.text(`${k}:`, 30, y);
    doc.setFont("helvetica", "normal");
    doc.text(String(v || "-"), 90, y);
    y += 12;
  };

  row("Tracking ID", booking.trackId);
  row("Status", (booking.status || "PENDING").toUpperCase());
  row("Room", booking.room);
  row("Division", booking.division);
  row("Date", booking.date);
  row("Time", `${booking.start} â€“ ${booking.end}`);
  row("Team", booking.team || "-");
  row("Attendees", booking.attendees);
  row("Booked By", booking.user || booking.email);

  // Add Status Text (Large)
  y += 10;
  doc.setFontSize(24);
  const status = (booking.status || "PENDING").toUpperCase();
  if (status === "APPROVED") {
    doc.setTextColor(34, 197, 94); // Green
    doc.text("APPROVED", 105, y, { align: "center" });
  } else if (status === "REJECTED") {
    doc.setTextColor(239, 68, 68); // Red
    doc.text("REJECTED", 105, y, { align: "center" });
  } else {
    doc.setTextColor(234, 179, 8); // Yellow
    doc.text("PENDING APPROVAL", 105, y, { align: "center" });
  }

  // Add Seal at bottom right
  try {
    const sealData = await getBase64Image("assets/seal.png");
    doc.addImage(sealData, "PNG", 150, 230, 40, 40);
  } catch (e) {
    console.warn("Seal failed to load");
  }

  doc.setFontSize(10);
  doc.setTextColor(150);
  doc.text("Generated by SFO Meeting Suite Enterprise Portal", 105, 285, { align: "center" });
  doc.text(new Date().toLocaleString(), 105, 290, { align: "center" });

  const blob = doc.output("blob");
  return blob;
}

/* ===============================
   AUTO DOWNLOAD
================================ */
async function downloadPDF() {
  const blob = await generatePDFBlob();
  if (!blob) return alert("PDF unavailable");

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `SFO_Booking_${booking.trackId}.pdf`;
  a.click();

  setTimeout(() => URL.revokeObjectURL(url), 2000);
}

/* ===============================
   EMAIL (COMPOSE EMAIL)
================================ */
function emailBooking() {
  const subject = encodeURIComponent(
    `Meeting Room Booking - ${booking.room}`
  );

  const body = encodeURIComponent(`
Hello,

Your meeting room booking details:

ğŸ“Œ Tracking ID: ${booking.trackId}
ğŸ¢ Room: ${booking.room}
ğŸ›ï¸ Division: ${booking.division}
ğŸ‘¥ Team: ${booking.team || "-"}
ğŸ“… Date: ${booking.date}
â° Time: ${booking.start} â€“ ${booking.end}
ğŸ‘¨â€ğŸ’¼ Attendees: ${booking.attendees || 0}
ğŸ“Š Status: ${booking.status}

Please download the PDF for full details.

Regards,
SFO Meeting Suite
`.trim());

  const mailto = `mailto:${booking.email || ''}?subject=${subject}&body=${body}`;
  window.location.href = mailto;
}

/* ===============================
   AUTO PDF ON LOAD - DISABLED
   User can manually download if needed
================================ */
// setTimeout(downloadPDF, 900);
